name: monitoring-setup
description: Custom action to setup monitoring stack
author: Platform Team
version: "1.0.0"

parameters:
  - name: monitoring_type
    description: "Type of monitoring to setup"
    type: choice
    default: "all"
    values: ["all", "prometheus", "grafana", "alertmanager"]
  - name: namespace
    description: "Monitoring namespace"
    type: string
    default: "monitoring"
  - name: storage_size
    description: "Storage size for monitoring components"
    type: string
    default: "10Gi"
  - name: retention_period
    description: "Data retention period"
    type: string
    default: "15d"

requirements:
  - model: linux
    os: ubuntu
    memory: 2048

steps:
  - name: setup-helm
    script: |
      #!/bin/bash
      set -e
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      helm version

  - name: add-helm-repositories
    script: |
      #!/bin/bash
      set -e
      helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      helm repo add grafana https://grafana.github.io/helm-charts
      helm repo update

  - name: install-monitoring
    script: |
      #!/bin/bash
      set -e
      NAMESPACE="{{.namespace}}"
      STORAGE="{{.storage_size}}"
      RETENTION="{{.retention_period}}"
      TYPE="{{.monitoring_type}}"

      kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      if [ "$TYPE" = "all" ] || [ "$TYPE" = "prometheus" ]; then
        helm upgrade --install prometheus prometheus-community/prometheus --namespace $NAMESPACE --set server.persistentVolume.size=$STORAGE --set server.retention=$RETENTION --wait
      fi

      if [ "$TYPE" = "all" ] || [ "$TYPE" = "grafana" ]; then
        helm upgrade --install grafana grafana/grafana --namespace $NAMESPACE --set persistence.enabled=true --set persistence.size=$STORAGE --wait
      fi
